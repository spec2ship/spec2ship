# LLM Instruction Patterns

This document defines patterns for writing effective LLM instructions in Spec2Ship.

---

## Positive/Negative Instructions

Use explicit positive and negative instructions for critical requirements.

### Pattern

```markdown
**YOU MUST** {required action}
**NEVER** {forbidden action}
```

### Examples

```markdown
**YOU MUST use Write tool NOW** to create the session file.

**NEVER** use Task with generic prompt - always invoke the agent file.

**YOU MUST** verify the session file exists before proceeding.
```

### When to Use

- Critical steps that must not be skipped
- Common mistakes that need prevention
- Tool invocation requirements

---

## Validation Steps

Add validation after critical operations.

### Pattern

```markdown
#### Step X.Xb: Validate {Operation}

**Non-blocking validation** - display warnings but continue execution.

1. **Verify {item 1}**:
   - Check {condition}
   - Expected: {value}

2. **Verify {item 2}**:
   - Check {condition}

3. **If validation fails**:
   ```
   Warning: {CATEGORY} WARNING
   Missing:
   - {list of missing items}

   Continuing execution...
   ```
```

### Example

```markdown
#### Step 2.6b: Validate Round Output

**Non-blocking validation** - display warnings but continue execution.

1. **Verify session file updated**:
   - Check `rounds[]` contains current round N
   - Check `artifacts.{type}[]` contains new IDs

2. **If validation fails**:
   ```
   Warning: ROUND VALIDATION WARNING
   Missing:
   - Session file not updated with round 3
   - REQ-005 not in artifacts.requirements

   Continuing execution...
   ```
```

---

## Warning Formatting

Use consistent warning format for **execution flow validation failures** (e.g., Step 2.6b).

**Note**: This pattern is for warnings during command execution (e.g., roundtable rounds). Validation **reporting tools** (like `/s2s:session:validate`) may use different formats for showing individual check results.

### Pattern

```
⚠️ {CATEGORY} WARNING
{details}
```

### Standard Categories

| Category | Emoji | Use |
|----------|-------|-----|
| VALIDATION | Warning symbol | Output doesn't match expectations |
| STATE | Warning symbol | State inconsistency detected |
| DEPRECATION | Warning symbol | Using deprecated feature |
| PERMISSION | Warning symbol | Permission issue |
| STALE | Warning symbol | Data may be outdated |

### Example

```
Warning: VALIDATION WARNING
Session file missing round 3 entry.
Expected: rounds array with entry for round 3
Found: rounds array ends at round 2

Continuing execution...
```

---

## Immutability Headers

Mark generated files that should not be manually modified.

### Pattern

```markdown
<!-- WARNING: IMMUTABLE - Generated by {command}. Manual edits will be lost. -->
```

### When to Use

Add immutability headers to:
- Generated requirements documents (`requirements.md`)
- Generated architecture docs (`README.md`, `components.md`)
- Generated ADRs from roundtable sessions
- Generated summaries (brainstorm summaries, etc.)

### Examples

```markdown
<!-- WARNING: IMMUTABLE - Generated by /s2s:specs. Manual edits will be lost. -->

<!-- WARNING: IMMUTABLE - Generated by /s2s:design. Manual edits will be lost. -->

<!-- WARNING: IMMUTABLE - Generated by /s2s:brainstorm. Manual edits will be lost. -->
```

### Exception

Do NOT add immutability headers to:
- `CONTEXT.md` - users should edit this
- `CLAUDE.md` - users add custom directives
- Session YAML files - system-managed but may need debugging

---

## Agent Invocation

Always use the exact pattern for invoking agents.

### Correct Pattern

```markdown
**Use the roundtable-{role} agent** with this input:

```yaml
{input}
```
```

### Wrong Patterns

```markdown
# WRONG - Creates generic agent without config
Task(subagent_type="general-purpose", prompt="You are a facilitator...")

# WRONG - Missing "Use the" prefix
Launch roundtable-facilitator with this input:

# WRONG - Using Task tool directly
I'll use the Task tool to create a facilitator agent...
```

---

## Conditional Logic

Structure conditional instructions clearly.

### Pattern

```markdown
**IF** {condition}:
  {action}

**IF** {condition} **AND** {condition}:
  {action}

**IF** {condition}:
  {action}
**ELSE**:
  {action}
```

### Example

```markdown
**IF** verbose_flag == true:
  Write dump to `rounds/{NNN}-01-facilitator-question.yaml`

**IF** round_number < 3 **AND** next == "conclude":
  Override to "continue" (minimum rounds not met)

**IF** interactive_flag == true:
  Ask user to continue, skip, or exit
**ELSE**:
  Proceed automatically
```

---

## Template Placeholders

Use consistent placeholder syntax.

### Pattern

```yaml
field: "{placeholder_name}"
field: {from source}
field: "{from context-snapshot.yaml: path.to.value}"
```

### Examples

```yaml
# Simple placeholder
id: "{session-id}"
topic: "{project name}"

# Source reference
min_rounds: {from config-snapshot.yaml: limits.min_rounds}
strategy: {from arg or default}

# Computed
timestamp: "{ISO timestamp}"
duration_ms: {calculated}
```

---

## Sequential Steps

Use numbered steps with clear tool instructions.

### Pattern

```markdown
### Step N.N: {Step Title}

**YOU MUST use {Tool} tool NOW** to {action}.

{Details or template}

**Result**: {expected outcome}
```

### Example

```markdown
### Step 1.4: Create Session Index File

**YOU MUST use Write tool NOW** to create `.s2s/sessions/{session-id}.yaml`:

```yaml
id: "{session-id}"
status: "active"
...
```

**Result**: Session file ready for round execution
```

---

## Parallel Execution

Explicitly mark parallel vs sequential operations.

### Pattern

```markdown
**Launch ALL participant agents in SINGLE message** (parallel execution):

For each of: {list}
```

### Example

```markdown
**Launch ALL participant agents in SINGLE message** (parallel execution):

For each of: product-manager, business-analyst, qa-lead

**Use the roundtable-{participant-id} agent** with this input:
...
```

---

## Context Boundaries

Clearly mark what context is available to agents.

### Pattern

```markdown
# ALL context inline (agent has NO tools)
context:
  project_summary: |
    {content}
  relevant_artifacts:
    - {artifact}
```

### Rationale

Participants have `tools: []` and cannot read files. All necessary context must be provided inline. Use this pattern to remind the command author that context must be complete.

---

## Error Recovery

Provide actionable recovery for errors.

### Pattern

```markdown
**If {error condition}**:
  1. {Recovery action 1}
  2. {Recovery action 2}
  3. {Fallback if recovery fails}
```

### Example

```markdown
**If session file is corrupted**:
  1. Attempt repair from rounds/ verbose dumps
  2. If repair fails, offer user choice: reset or abandon
  3. Log corruption details for debugging
```
